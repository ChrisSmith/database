select
    supp_nation,
    cust_nation,
    l_year,
    sum(volume) as revenue
from (
    select
        n1.n_name as supp_nation,
        n2.n_name as cust_nation,
        extract(year from l_shipdate) as l_year,
        l_extendedprice * (1 - l_discount) as volume
    from
        supplier,
        lineitem,
        orders,
        customer,
        nation n1,
        nation n2
    where
            s_suppkey = l_suppkey
        and o_orderkey = l_orderkey
        and c_custkey = o_custkey
        and s_nationkey = n1.n_nationkey
        and c_nationkey = n2.n_nationkey
        and (
            (n1.n_name = 'FRANCE' and n2.n_name = 'GERMANY')
            or (n1.n_name = 'GERMANY' and n2.n_name = 'FRANCE')
        )
        and l_shipdate between date '1995-01-01' and date '1996-12-31'
    ) as shipping
group by
    supp_nation,
    cust_nation,
    l_year
order by
    supp_nation,
    cust_nation,
    l_year;


Original
Project(supp_nation, cust_nation, l_year, revenue) -> .supp_nation, .cust_nation, .l_year, .revenue
 Sort(supp_nation ASC, cust_nation ASC, l_year ASC) -> .revenue, .supp_nation, .cust_nation, .l_year 
    Agg(sum(volume), supp_nation, cust_nation, l_year) group by (supp_nation, cust_nation, l_year) -> .revenue, .supp_nation, .cust_nation, .l_year    
       Project(n_name, n_name, extract(year, l_shipdate), l_extendedprice * cast(1 as Decimal) - l_discount) -> shipping.supp_nation, shipping.cust_nation, shipping.l_year, shipping.volume       
          JoinSet(supplier (Inner) x lineitem (Inner) x orders (Inner) x customer (Inner) x n1 (Inner) x n2 (Inner)) -> .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment, .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment, .c_custkey, .c_name, .c_address, .c_nationkey, .c_phone, .c_acctbal, .c_mktsegment, .c_comment, n1.n_nationkey, n1.n_name, n1.n_regionkey, n1.n_comment, n2.n_nationkey, n2.n_name, n2.n_regionkey, n2.n_comment          
          BinaryEdge { Expression = s_suppkey = l_suppkey, One = supplier, Two = lineitem }
          BinaryEdge { Expression = o_orderkey = l_orderkey, One = lineitem, Two = orders }
          BinaryEdge { Expression = c_custkey = o_custkey, One = orders, Two = customer }
          BinaryEdge { Expression = s_nationkey = n_nationkey, One = supplier, Two = n1 }
          BinaryEdge { Expression = c_nationkey = n_nationkey, One = customer, Two = n2 }
          BinaryEdge { Expression = n_name = FRANCE and n_name = GERMANY or n_name = GERMANY and n_name = FRANCE, One = n1, Two = n2 }
          UnaryEdge { Expression = l_shipdate between 01/01/1995 00:00:00 and 12/31/1996 00:00:00, Relation = lineitem }
             Scan(supplier) -> .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment             
             Scan(lineitem) -> .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment             
             Scan(orders) -> .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment             
             Scan(customer) -> .c_custkey, .c_name, .c_address, .c_nationkey, .c_phone, .c_acctbal, .c_mktsegment, .c_comment             
             Scan(nation) -> n1.n_nationkey, n1.n_name, n1.n_regionkey, n1.n_comment             
             Scan(nation) -> n2.n_nationkey, n2.n_name, n2.n_regionkey, n2.n_comment             


Optimized
Project(supp_nation, cust_nation, l_year, revenue) -> .supp_nation, .cust_nation, .l_year, .revenue
 Sort(supp_nation ASC, cust_nation ASC, l_year ASC) -> .revenue, .supp_nation, .cust_nation, .l_year 
    Agg(sum(volume), supp_nation, cust_nation, l_year) group by (supp_nation, cust_nation, l_year) -> .revenue, .supp_nation, .cust_nation, .l_year    
       Project(n_name, n_name, extract(year, l_shipdate), l_extendedprice * cast(1 as Decimal) - l_discount) -> shipping.supp_nation, shipping.cust_nation, shipping.l_year, shipping.volume       
          Filter(n_name = FRANCE and n_name = GERMANY or n_name = GERMANY and n_name = FRANCE) -> .s_suppkey, .s_nationkey, .l_orderkey, .l_suppkey, .l_extendedprice, .l_discount, .l_shipdate, .o_orderkey, .o_custkey, .c_custkey, .c_nationkey, n1.n_nationkey, n1.n_name, n2.n_nationkey, n2.n_name          
             Join(Inner on c_nationkey = n_nationkey) -> .s_suppkey, .s_nationkey, .l_orderkey, .l_suppkey, .l_extendedprice, .l_discount, .l_shipdate, .o_orderkey, .o_custkey, .c_custkey, .c_nationkey, n1.n_nationkey, n1.n_name, n2.n_nationkey, n2.n_name             
                Join(Inner on s_nationkey = n_nationkey) -> .s_suppkey, .s_nationkey, .l_orderkey, .l_suppkey, .l_extendedprice, .l_discount, .l_shipdate, .o_orderkey, .o_custkey, .c_custkey, .c_nationkey, n1.n_nationkey, n1.n_name                
                   Join(Inner on c_custkey = o_custkey) -> .s_suppkey, .s_nationkey, .l_orderkey, .l_suppkey, .l_extendedprice, .l_discount, .l_shipdate, .o_orderkey, .o_custkey, .c_custkey, .c_nationkey                   
                      Join(Inner on o_orderkey = l_orderkey) -> .s_suppkey, .s_nationkey, .l_orderkey, .l_suppkey, .l_extendedprice, .l_discount, .l_shipdate, .o_orderkey, .o_custkey                      
                         Join(Inner on s_suppkey = l_suppkey) -> .s_suppkey, .s_nationkey, .l_orderkey, .l_suppkey, .l_extendedprice, .l_discount, .l_shipdate                         
                            Scan(supplier) with projection  -> .s_suppkey, .s_nationkey                            
                         
                            Filter(l_shipdate between 01/01/1995 00:00:00 and 12/31/1996 00:00:00) -> .l_orderkey, .l_suppkey, .l_extendedprice, .l_discount, .l_shipdate                            
                               Scan(lineitem) with projection  -> .l_orderkey, .l_suppkey, .l_extendedprice, .l_discount, .l_shipdate                               
                      
                         Scan(orders) with projection  -> .o_orderkey, .o_custkey                         
                   
                      Scan(customer) with projection  -> .c_custkey, .c_nationkey                      
                
                   Scan(nation) with projection  -> n1.n_nationkey, n1.n_name                   
             
                Scan(nation) with projection  -> n2.n_nationkey, n2.n_name                


