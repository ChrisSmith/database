SELECT
    nation,
    o_year,
    sum(amount) as sum_profit
FROM (
    SELECT
        n_name as nation,
        extract(year from o_orderdate) as o_year,
        l_extendedprice * (1 - l_discount) - ps_supplycost * l_quantity as amount
    FROM
        part,
        supplier,
        lineitem,
        partsupp,
        orders,
        nation
    WHERE
        s_suppkey = l_suppkey
        AND ps_suppkey = l_suppkey
        AND ps_partkey = l_partkey
        AND p_partkey = l_partkey
        AND o_orderkey = l_orderkey
        AND s_nationkey = n_nationkey
        AND p_name LIKE '%green%'
) AS profit
GROUP BY
    nation,
    o_year
ORDER BY
    nation,
    o_year DESC;


Original
Project(nation, o_year, sum_profit) -> .nation, .o_year, .sum_profit
 Sort(nation ASC, o_year DESC) -> .nation, .o_year, .sum_profit 
    Agg(nation, o_year, sum(amount)) group by (nation, o_year) -> .nation, .o_year, .sum_profit    
       Project(n_name, extract(year, o_orderdate), l_extendedprice * cast(1 as Decimal) - l_discount - ps_supplycost * l_quantity) -> profit.nation, profit.o_year, profit.amount       
          Filter(s_suppkey = l_suppkey AND ps_suppkey = l_suppkey AND ps_partkey = l_partkey AND p_partkey = l_partkey AND o_orderkey = l_orderkey AND s_nationkey = n_nationkey AND p_name LIKE %green%) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment, .ps_partkey, .ps_suppkey, .ps_availqty, .ps_supplycost, .ps_comment, .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment, .n_nationkey, .n_name, .n_regionkey, .n_comment, .nation, .o_year, .amount          
             Project(n_name, extract(year, o_orderdate), l_extendedprice * cast(1 as Decimal) - l_discount - ps_supplycost * l_quantity) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment, .ps_partkey, .ps_suppkey, .ps_availqty, .ps_supplycost, .ps_comment, .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment, .n_nationkey, .n_name, .n_regionkey, .n_comment, .nation, .o_year, .amount             
                Join(Cross) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment, .ps_partkey, .ps_suppkey, .ps_availqty, .ps_supplycost, .ps_comment, .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment, .n_nationkey, .n_name, .n_regionkey, .n_comment                
                   Join(Cross) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment, .ps_partkey, .ps_suppkey, .ps_availqty, .ps_supplycost, .ps_comment, .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment                   
                      Join(Cross) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment, .ps_partkey, .ps_suppkey, .ps_availqty, .ps_supplycost, .ps_comment                      
                         Join(Cross) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment                         
                            Join(Cross) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment                            
                               Scan(part) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment                               
                            
                               Scan(supplier) -> .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment                               
                         
                            Scan(lineitem) -> .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment                            
                      
                         Scan(partsupp) -> .ps_partkey, .ps_suppkey, .ps_availqty, .ps_supplycost, .ps_comment                         
                   
                      Scan(orders) -> .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment                      
                
                   Scan(nation) -> .n_nationkey, .n_name, .n_regionkey, .n_comment                   


Optimized
Project(nation, o_year, sum_profit) -> .nation, .o_year, .sum_profit
 Sort(nation ASC, o_year DESC) -> .nation, .o_year, .sum_profit 
    Agg(nation, o_year, sum(amount)) group by (nation, o_year) -> .nation, .o_year, .sum_profit    
       Project(n_name, extract(year, o_orderdate), l_extendedprice * cast(1 as Decimal) - l_discount - ps_supplycost * l_quantity) -> profit.nation, profit.o_year, profit.amount       
          Filter(ps_suppkey = l_suppkey) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment, .ps_partkey, .ps_suppkey, .ps_availqty, .ps_supplycost, .ps_comment, .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment, .n_nationkey, .n_name, .n_regionkey, .n_comment, .nation, .o_year, .amount          
             Filter(s_suppkey = l_suppkey) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment, .ps_partkey, .ps_suppkey, .ps_availqty, .ps_supplycost, .ps_comment, .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment, .n_nationkey, .n_name, .n_regionkey, .n_comment, .nation, .o_year, .amount             
                Project(n_name, extract(year, o_orderdate), l_extendedprice * cast(1 as Decimal) - l_discount - ps_supplycost * l_quantity) -> .p_partkey, .p_name, .p_mfgr, .p_brand, .p_type, .p_size, .p_container, .p_retailprice, .p_comment, .s_suppkey, .s_name, .s_address, .s_nationkey, .s_phone, .s_acctbal, .s_comment, .l_orderkey, .l_partkey, .l_suppkey, .l_linenumber, .l_quantity, .l_extendedprice, .l_discount, .l_tax, .l_returnflag, .l_linestatus, .l_shipdate, .l_commitdate, .l_receiptdate, .l_shipinstruct, .l_shipmode, .l_comment, .ps_partkey, .ps_suppkey, .ps_availqty, .ps_supplycost, .ps_comment, .o_orderkey, .o_custkey, .o_orderstatus, .o_totalprice, .o_orderdate, .o_orderpriority, .o_clerk, .o_shippriority, .o_comment, .n_nationkey, .n_name, .n_regionkey, .n_comment, .nation, .o_year, .amount                
                   Join(Inner on s_nationkey = n_nationkey) -> .o_orderkey, .o_orderdate, .ps_partkey, .ps_suppkey, .ps_supplycost, .p_partkey, .p_name, .s_suppkey, .s_nationkey, .l_orderkey, .l_partkey, .l_suppkey, .l_quantity, .l_extendedprice, .l_discount, .n_nationkey, .n_name                   
                      Join(Inner on o_orderkey = l_orderkey) -> .o_orderkey, .o_orderdate, .ps_partkey, .ps_suppkey, .ps_supplycost, .p_partkey, .p_name, .s_suppkey, .s_nationkey, .l_orderkey, .l_partkey, .l_suppkey, .l_quantity, .l_extendedprice, .l_discount                      
                         Scan(orders) with projection  -> .o_orderkey, .o_orderdate                         
                      
                         Join(Inner on ps_partkey = l_partkey) -> .ps_partkey, .ps_suppkey, .ps_supplycost, .p_partkey, .p_name, .s_suppkey, .s_nationkey, .l_orderkey, .l_partkey, .l_suppkey, .l_quantity, .l_extendedprice, .l_discount                         
                            Scan(partsupp) with projection  -> .ps_partkey, .ps_suppkey, .ps_supplycost                            
                         
                            Join(Inner on p_partkey = l_partkey) -> .p_partkey, .p_name, .s_suppkey, .s_nationkey, .l_orderkey, .l_partkey, .l_suppkey, .l_quantity, .l_extendedprice, .l_discount                            
                               Join(Cross) -> .p_partkey, .p_name, .s_suppkey, .s_nationkey                               
                                  Filter(p_name LIKE %green%) -> .p_partkey, .p_name                                  
                                     Scan(part) with projection  -> .p_partkey, .p_name                                     
                               
                                  Scan(supplier) with projection  -> .s_suppkey, .s_nationkey                                  
                            
                               Scan(lineitem) with projection  -> .l_orderkey, .l_partkey, .l_suppkey, .l_quantity, .l_extendedprice, .l_discount                               
                   
                      Scan(nation) with projection  -> .n_nationkey, .n_name                      


